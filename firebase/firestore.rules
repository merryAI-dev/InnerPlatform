rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null
        && request.auth.token.email != null
        && request.auth.token.email.matches('.*@mysc\\.co\\.kr$');
    }

    function hasValidTenant(data, orgId) {
      return !data.keys().hasAny(['tenantId']) || data.tenantId == orgId;
    }

    function requestHasValidTenant(orgId) {
      return request.resource != null
        && request.resource.data.keys().hasAll(['tenantId'])
        && request.resource.data.tenantId == orgId;
    }

    function resourceHasValidTenant(orgId) {
      return resource != null && hasValidTenant(resource.data, orgId);
    }

    function memberDoc(orgId) {
      return get(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid));
    }

    function role(orgId) {
      return isSignedIn() ? memberDoc(orgId).data.role : null;
    }

    function isAdmin(orgId) {
      return role(orgId) == 'admin';
    }

    function isPrivileged(orgId) {
      return role(orgId) in ['admin', 'tenant_admin', 'finance', 'auditor'];
    }

    function selfMemberUpdateWithoutRoleChange(orgId, uid) {
      return isSignedIn()
        && request.auth.uid == uid
        && requestHasValidTenant(orgId)
        && resourceHasValidTenant(orgId)
        && request.resource.data.role == resource.data.role;
    }

    // Bootstrap admin emails can always update their own member doc (including role change)
    function isBootstrapAdminEmail() {
      return request.auth.token.email in ['mwbyun1220@mysc.co.kr', 'ai@mysc.co.kr', 'admin@mysc.co.kr'];
    }

    function memberProjectId(orgId) {
      return memberDoc(orgId).data.projectId;
    }

    function canReadProjectResource(orgId, projectId) {
      return isPrivileged(orgId)
        || (role(orgId) in ['pm', 'viewer'] && memberProjectId(orgId) == projectId);
    }

    function canWriteProjectResource(orgId, projectId) {
      return role(orgId) in ['admin', 'tenant_admin', 'finance']
        || (role(orgId) == 'pm' && memberProjectId(orgId) == projectId);
    }

    function projectIdFromTransaction(orgId, txId) {
      return get(/databases/$(database)/documents/orgs/$(orgId)/transactions/$(txId)).data.projectId;
    }

    function canReadTransactionResource(orgId, txId) {
      return canReadProjectResource(orgId, projectIdFromTransaction(orgId, txId));
    }

    function canWriteTransactionResource(orgId, txId) {
      return canWriteProjectResource(orgId, projectIdFromTransaction(orgId, txId));
    }

    match /orgs/{orgId}/members/{uid} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId);
      allow create: if isSignedIn() && request.auth.uid == uid && requestHasValidTenant(orgId);
      allow update: if (isAdmin(orgId) && resourceHasValidTenant(orgId) && requestHasValidTenant(orgId))
                    || selfMemberUpdateWithoutRoleChange(orgId, uid)
                    || (isBootstrapAdminEmail() && request.auth.uid == uid && requestHasValidTenant(orgId));
      allow delete: if isAdmin(orgId) && resourceHasValidTenant(orgId);
    }

    match /orgs/{orgId}/projects/{projectId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadProjectResource(orgId, projectId);
      allow create: if isSignedIn() && requestHasValidTenant(orgId) && canWriteProjectResource(orgId, projectId);
      allow update: if isSignedIn() && requestHasValidTenant(orgId) && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, projectId);
      allow delete: if isSignedIn() && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, projectId);
    }

    match /orgs/{orgId}/ledgers/{ledgerId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadProjectResource(orgId, resource.data.projectId);
      allow create: if isSignedIn() && requestHasValidTenant(orgId) && canWriteProjectResource(orgId, request.resource.data.projectId);
      allow update: if isSignedIn() && requestHasValidTenant(orgId) && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, resource.data.projectId);
      allow delete: if isSignedIn() && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, resource.data.projectId);
    }

    match /orgs/{orgId}/transactions/{txId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadProjectResource(orgId, resource.data.projectId);
      allow create: if isSignedIn() && requestHasValidTenant(orgId) && canWriteProjectResource(orgId, request.resource.data.projectId);
      allow update: if isSignedIn() && requestHasValidTenant(orgId) && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, resource.data.projectId);
      allow delete: if isSignedIn() && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, resource.data.projectId);
    }

    match /orgs/{orgId}/comments/{commentId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadTransactionResource(orgId, resource.data.transactionId);
      allow create: if isSignedIn() && requestHasValidTenant(orgId) && canWriteTransactionResource(orgId, request.resource.data.transactionId);
      allow update: if isSignedIn() && requestHasValidTenant(orgId) && resourceHasValidTenant(orgId) && canWriteTransactionResource(orgId, resource.data.transactionId);
      allow delete: if isSignedIn() && resourceHasValidTenant(orgId) && canWriteTransactionResource(orgId, resource.data.transactionId);
    }

    match /orgs/{orgId}/evidences/{evidenceId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadTransactionResource(orgId, resource.data.transactionId);
      allow create: if isSignedIn() && requestHasValidTenant(orgId) && canWriteTransactionResource(orgId, request.resource.data.transactionId);
      allow update: if isSignedIn() && requestHasValidTenant(orgId) && resourceHasValidTenant(orgId) && canWriteTransactionResource(orgId, resource.data.transactionId);
      allow delete: if isSignedIn() && resourceHasValidTenant(orgId) && canWriteTransactionResource(orgId, resource.data.transactionId);
    }

    match /orgs/{orgId}/audit_logs/{logId} {
      allow read: if isSignedIn() && isPrivileged(orgId) && resourceHasValidTenant(orgId);
      allow create: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    match /orgs/{orgId}/expense_sets/{setId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadProjectResource(orgId, resource.data.projectId);
      allow create: if isSignedIn() && requestHasValidTenant(orgId) && canWriteProjectResource(orgId, request.resource.data.projectId);
      allow update: if isSignedIn() && requestHasValidTenant(orgId) && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, resource.data.projectId);
      allow delete: if isSignedIn() && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, resource.data.projectId);
    }

    match /orgs/{orgId}/change_requests/{requestId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadProjectResource(orgId, resource.data.projectId);
      allow create: if isSignedIn() && requestHasValidTenant(orgId) && canWriteProjectResource(orgId, request.resource.data.projectId);
      allow update: if isSignedIn() && requestHasValidTenant(orgId) && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, resource.data.projectId);
      allow delete: if isSignedIn() && resourceHasValidTenant(orgId) && canWriteProjectResource(orgId, resource.data.projectId);
    }

    match /orgs/{orgId}/hr_announcements/{announcementId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId);
      allow create, update: if isSignedIn() && isAdmin(orgId) && requestHasValidTenant(orgId);
      allow delete: if isSignedIn() && isAdmin(orgId) && resourceHasValidTenant(orgId);
    }

    match /orgs/{orgId}/project_change_alerts/{alertId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId);
      allow create: if isSignedIn() && isAdmin(orgId) && requestHasValidTenant(orgId);
      allow delete: if isSignedIn() && isAdmin(orgId) && resourceHasValidTenant(orgId);
      allow update: if isSignedIn() && requestHasValidTenant(orgId) && resourceHasValidTenant(orgId) && (
        isAdmin(orgId) ||
        (role(orgId) == 'pm' && memberProjectId(orgId) == resource.data.projectId)
      );
    }

    // ── Company Board (전사 게시판) ──

    match /orgs/{orgId}/board_posts/{postId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId);
      allow create: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && request.resource.data.id == postId
                    && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && resourceHasValidTenant(orgId)
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.createdBy == resource.data.createdBy
                    && (
                      // Author can edit content fields.
                      (
                        resource.data.createdBy == request.auth.uid
                        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                          'title',
                          'body',
                          'tags',
                          'channel',
                          'updatedAt',
                          'lastActivityAt',
                          'deletedAt'
                        ])
                      )
                      ||
                      // Any signed-in user may update counters (vote/comment aggregates) via transactions.
                      (
                        request.resource.data.diff(resource.data).changedKeys().hasOnly([
                          'commentCount',
                          'upvoteCount',
                          'downvoteCount',
                          'voteScore',
                          'updatedAt',
                          'lastActivityAt'
                        ])
                      )
                    );
      allow delete: if false;
    }

    match /orgs/{orgId}/board_comments/{commentId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId);
      allow create: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && request.resource.data.id == commentId
                    && request.resource.data.createdBy == request.auth.uid;
      allow update: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && resourceHasValidTenant(orgId)
                    && resource.data.createdBy == request.auth.uid
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                      'body',
                      'updatedAt',
                      'deletedAt'
                    ]);
      allow delete: if false;
    }

    match /orgs/{orgId}/board_votes/{voteId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId);
      allow create: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && request.resource.data.id == voteId
                    && request.resource.data.voterId == request.auth.uid;
      allow update: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && resourceHasValidTenant(orgId)
                    && resource.data.voterId == request.auth.uid
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.voterId == resource.data.voterId
                    && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                      'value',
                      'updatedAt'
                    ]);
      allow delete: if isSignedIn() && resourceHasValidTenant(orgId) && resource.data.voterId == request.auth.uid;
    }

    // ── Cashflow Weekly Sheet (주간 캐시플로 시트) ──

    match /orgs/{orgId}/cashflow_weeks/{weekId} {
      allow read: if isSignedIn()
                  && resourceHasValidTenant(orgId)
                  && canReadProjectResource(orgId, resource.data.projectId);
      allow create: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && request.resource.data.id == weekId
                    && canWriteProjectResource(orgId, request.resource.data.projectId);
      allow update: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && resourceHasValidTenant(orgId)
                    && canWriteProjectResource(orgId, resource.data.projectId)
                    && (
                      // Admin/finance/tenant_admin can close weeks and edit anything in-scope.
                      role(orgId) in ['admin', 'finance', 'tenant_admin']
                      ||
                      // PM can edit amounts + submit, but cannot close.
                      (
                        role(orgId) == 'pm'
                        && memberProjectId(orgId) == resource.data.projectId
                        && request.resource.data.projectId == resource.data.projectId
                        && request.resource.data.yearMonth == resource.data.yearMonth
                        && request.resource.data.weekNo == resource.data.weekNo
                        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                          'projection',
                          'actual',
                          'pmSubmitted',
                          'pmSubmittedAt',
                          'pmSubmittedByUid',
                          'pmSubmittedByName',
                          'updatedAt',
                          'updatedByUid',
                          'updatedByName',
                          'tenantId'
                        ])
                      )
                    );
      allow delete: if false;
    }

    // ── Payroll (인건비 공지/확인) ──

    match /orgs/{orgId}/payroll_schedules/{projectId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadProjectResource(orgId, projectId);
      allow create: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && canWriteProjectResource(orgId, projectId)
                    && request.resource.data.id == projectId
                    && request.resource.data.projectId == projectId;
      allow update: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && resourceHasValidTenant(orgId)
                    && canWriteProjectResource(orgId, projectId)
                    && request.resource.data.projectId == resource.data.projectId;
      allow delete: if isSignedIn() && isAdmin(orgId) && resourceHasValidTenant(orgId);
    }

    match /orgs/{orgId}/payroll_runs/{runId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadProjectResource(orgId, resource.data.projectId);
      allow create: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && request.resource.data.id == runId
                    && (
                      role(orgId) in ['admin', 'finance']
                      || (role(orgId) == 'pm' && memberProjectId(orgId) == request.resource.data.projectId)
                    );
      allow update: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && resourceHasValidTenant(orgId)
                    && (
                      // Admin/finance can manage payroll run status for any accessible project.
                      (
                        role(orgId) in ['admin', 'finance']
                        && canWriteProjectResource(orgId, resource.data.projectId)
                      )
                      ||
                      // PM can only acknowledge notices for their own project.
                      (
                        role(orgId) == 'pm'
                        && memberProjectId(orgId) == resource.data.projectId
                        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                          'acknowledged',
                          'acknowledgedAt',
                          'acknowledgedByUid',
                          'acknowledgedByName',
                          'updatedAt'
                        ])
                      )
                    );
      allow delete: if false;
    }

    match /orgs/{orgId}/monthly_closes/{closeId} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId) && canReadProjectResource(orgId, resource.data.projectId);
      allow create: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && request.resource.data.id == closeId
                    && role(orgId) in ['admin', 'finance'];
      allow update: if isSignedIn()
                    && requestHasValidTenant(orgId)
                    && resourceHasValidTenant(orgId)
                    && (
                      (
                        role(orgId) in ['admin', 'finance']
                        && canWriteProjectResource(orgId, resource.data.projectId)
                      )
                      ||
                      (
                        role(orgId) == 'pm'
                        && memberProjectId(orgId) == resource.data.projectId
                        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                          'acknowledged',
                          'acknowledgedAt',
                          'acknowledgedByUid',
                          'acknowledgedByName',
                          'updatedAt'
                        ])
                      )
                    );
      allow delete: if false;
    }

    match /orgs/{orgId}/{document=**} {
      allow read: if isSignedIn() && resourceHasValidTenant(orgId);
      allow create: if isSignedIn() && isAdmin(orgId) && requestHasValidTenant(orgId);
      allow update, delete: if isSignedIn() && isAdmin(orgId) && resourceHasValidTenant(orgId) && requestHasValidTenant(orgId);
    }
  }
}
